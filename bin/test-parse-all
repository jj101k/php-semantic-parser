#!/usr/bin/env node
const assert = require("assert")
const child_process = require("child_process")
const fs = require("fs")
const PHPSemanticParser = require("../index")

const paths = process.argv.slice(2)
if(!paths.length) {
    throw new Error("Too few arguments")
}

child_process.exec(`find ${paths.map(s => JSON.stringify(s)).join(" ")} -name '*.php'`, {}, (e, out, err) => {
    if(!e) {
        const files = out.replace(/\n$/, "").split(/\n/)
        const fl = "" + files.length
        for(const [i, filename] of Object.entries(files)) {
            const display_n = "" + (+i+1)
            process.stdout.write(`\r[${display_n.padStart(fl.length)}/${fl}]`)
            try {
                const simple_test = fs.readFileSync(filename, {encoding: "utf8"})
                const p2 = new PHPSemanticParser(simple_test)
                assert.ok(p2.parse(), "Parse works")
            } catch(e) {
                console.log(`Failed at: ${filename}`)
                throw e
            }
        }
    }
})
